-----------------------------------------------------------------------------------------------------------------------------------------
-- VRP
-----------------------------------------------------------------------------------------------------------------------------------------
local Tunnel = module("vrp","lib/Tunnel")
local Proxy = module("vrp","lib/Proxy")
vRP = Proxy.getInterface("vRP")
-----------------------------------------------------------------------------------------------------------------------------------------
-- CONEXÃO
-----------------------------------------------------------------------------------------------------------------------------------------
src = {}
Tunnel.bindInterface("vrp_chest",src)
vSERVER = Tunnel.getInterface("vrp_chest")
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIAVEIS
-----------------------------------------------------------------------------------------------------------------------------------------
local chestTimer = 0
local chestOpen = ""
-----------------------------------------------------------------------------------------------------------------------------------------
-- STARTFOCUS
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	SetNuiFocus(false,false)
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- CHESTCLOSE
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("chestClose",function(data)
	SetNuiFocus(false,false)
	SendNUIMessage({ action = "hideMenu" })
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- TAKEITEM
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("takeItem",function(data)
	vSERVER.takeItem(tostring(chestOpen),data.item,data.amount)
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- STOREITEM
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("storeItem",function(data)
	vSERVER.storeItem(tostring(chestOpen),data.item,data.amount)
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- AUTO-UPDATE
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNetEvent("Creative:UpdateChest")
AddEventHandler("Creative:UpdateChest",function(action)
	SendNUIMessage({ action = action })
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- REQUESTCHEST
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterNUICallback("requestChest",function(data,cb)
	local inventario,inventario2,peso,maxpeso,peso2,maxpeso2 = vSERVER.openChest(tostring(chestOpen))
	if inventario then
		cb({ inventario = inventario, inventario2 = inventario2, peso = peso, maxpeso = maxpeso, peso2 = peso2, maxpeso2 = maxpeso2 })
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIAVEIS
-----------------------------------------------------------------------------------------------------------------------------------------
local chest = {
	{ "Coronel",-1089.19,-811.62,11.04 	},
	{ "bpg",459.36,-990.91,24.92 	},
	{ "Mare",2066.64,17.24,216.81 		},
	--{ "helipa",2049.66,-149.50,267.03  },
	{ "Rocinha",1663.49,-51.67,168.32   }, -- Baú da Helipa chama-se Rocinha.
	{ "Motoclub",976.93,-103.78,74.85   },	
	{ "Vidigal",1740.43,77.95,171.42 	},
	--{ "Desmanche",84.93,-1963.72,21.17  },
	{ "Chefe",725.69,-1065.48,28.32  }, -- permissão para chefes da mecanica temporariamente no desmanche
	{ "Mecanico",-206.62,-1341.73,34.89 },
	--{ "Italianos",-809.76,172.96,76.75  },
	{ "Italianos",464.49,-3118.41,6.08  },
	{ "Italianos",106.34,-1305.64,28.77  },
	--{ "Yakuza",-1042.1,-233.81,37.97 	},
	--{ "Advocacia",-82.71,-809.81,243.38 },
	{ "bdel",818.69,150.6,82.82	    },
	{ "Policia",-1081.57,-814.9,11.04	    },
	{ "bdel",452.74,-973.49,30.69 	},
	{ "Vanilla",92.52,-1291.78,29.27	},
	{ "Prefeitura",-82.9,-803.65,243.39	},
	{ "Zeronze",847.75,-286.86,73.12	}
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- CHESTTIMER
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(3000)
		if chestTimer > 0 then
			chestTimer = chestTimer - 3
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- CHEST
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterCommand("chest",function(source,args)
	local ped = PlayerPedId()
	local x,y,z = table.unpack(GetEntityCoords(ped))
	for k,v in pairs(chest) do
		local distance = Vdist(x,y,z,v[2],v[3],v[4])
		if distance <= 2.0 and chestTimer <= 0 then
			chestTimer = 3
			if vSERVER.checkIntPermissions(v[1]) then
				SetNuiFocus(true,true)
				SendNUIMessage({ action = "showMenu" })
				chestOpen = v[1]
			end
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- MARKER
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	--SetNuiFocus(false,false)
	while true do
	Citizen.Wait(5)
	local ped = PlayerPedId()
	local x,y,z = table.unpack(GetEntityCoords(ped))
		for k,v in pairs(chest) do
			if Vdist(x,y,z,v[2],v[3],v[4]) <= 5.5 then
				DrawMarker(21,v[2],v[3],v[4]-0.6,0,0,0,0.0,0,0,0.4,0.4,0.3,50,200,50,100,0,0,0,1)
				if IsControlJustPressed(0,38) then
				  	if Vdist(x,y,z,v[2],v[3],v[4]) <= 1.5 then
						if vSERVER.checkIntPermissions(v[1]) then
							SetNuiFocus(true,true)
							SendNUIMessage({ action = "showMenu" })
							chestOpen = v[1]
						end
				  	end
				end
			end
		end
	end
end)
